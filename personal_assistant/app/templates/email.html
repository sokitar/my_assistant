{% extends "base.html" %}

{% block title %}Personal Assistant - Email{% endblock %}

{% block extra_css %}
<style>
    .email-list {
        max-height: 60vh;
        overflow-y: auto;
    }
    
    .email-item {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .email-item:hover {
        background-color: rgba(0, 123, 255, 0.1);
    }
    
    .email-item.unread {
        font-weight: bold;
    }
    
    .email-preview {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .email-detail {
        max-height: 60vh;
        overflow-y: auto;
    }
    
    .compose-form label {
        font-weight: 500;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12 mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="fas fa-envelope me-2"></i>Email</h2>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#composeModal">
                <i class="fas fa-pen me-1"></i>Compose
            </button>
        </div>
    </div>
</div>

<div class="row">
    <!-- Email List -->
    <div class="col-md-4">
        <div class="card shadow">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Inbox</h5>
                <div>
                    <button class="btn btn-sm btn-light" id="refresh-btn" title="Refresh">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="list-group email-list" id="email-list">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading emails...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header bg-light">
                <h6 class="mb-0">Search</h6>
            </div>
            <div class="card-body">
                <form id="search-form">
                    <div class="input-group">
                        <input type="text" class="form-control" id="search-input" placeholder="Search emails...">
                        <button class="btn btn-outline-primary" type="submit">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Email Detail -->
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-header bg-light">
                <h5 class="mb-0" id="email-detail-header">Select an email to view</h5>
            </div>
            <div class="card-body email-detail" id="email-detail">
                <div class="text-center py-5 text-muted">
                    <i class="fas fa-envelope fa-3x mb-3"></i>
                    <p>Select an email from the list to view its contents</p>
                </div>
            </div>
            <div class="card-footer" id="email-actions" style="display: none;">
                <div class="btn-group">
                    <button class="btn btn-outline-primary" id="reply-btn">
                        <i class="fas fa-reply me-1"></i>Reply
                    </button>
                    <button class="btn btn-outline-primary" id="forward-btn">
                        <i class="fas fa-share me-1"></i>Forward
                    </button>
                    <button class="btn btn-outline-danger" id="delete-btn">
                        <i class="fas fa-trash me-1"></i>Delete
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Compose Modal -->
<div class="modal fade" id="composeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-pen me-2"></i>Compose Email
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="compose-form" class="compose-form">
                    <div class="mb-3">
                        <label for="to" class="form-label">To:</label>
                        <input type="email" class="form-control" id="to" required>
                    </div>
                    <div class="mb-3">
                        <label for="cc" class="form-label">CC:</label>
                        <input type="email" class="form-control" id="cc">
                    </div>
                    <div class="mb-3">
                        <label for="bcc" class="form-label">BCC:</label>
                        <input type="email" class="form-control" id="bcc">
                    </div>
                    <div class="mb-3">
                        <label for="subject" class="form-label">Subject:</label>
                        <input type="text" class="form-control" id="subject" required>
                    </div>
                    <div class="mb-3">
                        <label for="body" class="form-label">Message:</label>
                        <textarea class="form-control" id="body" rows="10" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="send-btn">
                    <i class="fas fa-paper-plane me-1"></i>Send
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Reply Modal -->
<div class="modal fade" id="replyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-reply me-2"></i><span id="reply-title">Reply</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="reply-form" class="compose-form">
                    <div class="mb-3">
                        <label for="reply-to" class="form-label">To:</label>
                        <input type="email" class="form-control" id="reply-to" required>
                    </div>
                    <div class="mb-3">
                        <label for="reply-cc" class="form-label">CC:</label>
                        <input type="email" class="form-control" id="reply-cc">
                    </div>
                    <div class="mb-3">
                        <label for="reply-subject" class="form-label">Subject:</label>
                        <input type="text" class="form-control" id="reply-subject" required>
                    </div>
                    <div class="mb-3">
                        <label for="reply-body" class="form-label">Message:</label>
                        <textarea class="form-control" id="reply-body" rows="10" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="reply-send-btn">
                    <i class="fas fa-paper-plane me-1"></i>Send
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const emailList = document.getElementById('email-list');
        const emailDetailHeader = document.getElementById('email-detail-header');
        const emailDetail = document.getElementById('email-detail');
        const emailActions = document.getElementById('email-actions');
        const refreshBtn = document.getElementById('refresh-btn');
        const searchForm = document.getElementById('search-form');
        const searchInput = document.getElementById('search-input');
        const composeForm = document.getElementById('compose-form');
        const sendBtn = document.getElementById('send-btn');
        const replyBtn = document.getElementById('reply-btn');
        const forwardBtn = document.getElementById('forward-btn');
        const deleteBtn = document.getElementById('delete-btn');
        const replyForm = document.getElementById('reply-form');
        const replyTitle = document.getElementById('reply-title');
        const replySendBtn = document.getElementById('reply-send-btn');
        
        let currentEmail = null;
        
        // Load unread emails on page load
        loadEmails();
        
        // Refresh emails when refresh button is clicked
        refreshBtn.addEventListener('click', function() {
            loadEmails();
        });
        
        // Search emails when search form is submitted
        searchForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const query = searchInput.value.trim();
            if (query) {
                searchEmails(query);
            } else {
                loadEmails();
            }
        });
        
        // Send email when send button is clicked
        sendBtn.addEventListener('click', function() {
            if (composeForm.checkValidity()) {
                sendEmail();
            } else {
                composeForm.reportValidity();
            }
        });
        
        // Reply to email when reply button is clicked
        replyBtn.addEventListener('click', function() {
            if (currentEmail) {
                prepareReply(false);
            }
        });
        
        // Forward email when forward button is clicked
        forwardBtn.addEventListener('click', function() {
            if (currentEmail) {
                prepareReply(true);
            }
        });
        
        // Delete email when delete button is clicked
        deleteBtn.addEventListener('click', function() {
            if (currentEmail) {
                deleteEmail();
            }
        });
        
        // Send reply when reply send button is clicked
        replySendBtn.addEventListener('click', function() {
            if (replyForm.checkValidity()) {
                sendReply();
            } else {
                replyForm.reportValidity();
            }
        });
        
        // Function to load unread emails
        function loadEmails() {
            emailList.innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading emails...</p>
                </div>
            `;
            
            fetch('/api/email/unread')
                .then(response => response.json())
                .then(emails => {
                    if (emails.length === 0) {
                        emailList.innerHTML = `
                            <div class="text-center py-5 text-muted">
                                <i class="fas fa-inbox fa-3x mb-3"></i>
                                <p>No unread emails</p>
                            </div>
                        `;
                    } else {
                        emailList.innerHTML = '';
                        emails.forEach(email => {
                            const date = new Date(email.date);
                            const formattedDate = date.toLocaleDateString();
                            
                            const emailItem = document.createElement('a');
                            emailItem.href = '#';
                            emailItem.classList.add('list-group-item', 'list-group-item-action', 'email-item');
                            if (email.unread) {
                                emailItem.classList.add('unread');
                            }
                            emailItem.innerHTML = `
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">${email.from}</h6>
                                    <small>${formattedDate}</small>
                                </div>
                                <p class="mb-1 fw-bold">${email.subject}</p>
                                <p class="mb-0 email-preview">${email.snippet}</p>
                            `;
                            
                            emailItem.addEventListener('click', function(e) {
                                e.preventDefault();
                                viewEmail(email);
                            });
                            
                            emailList.appendChild(emailItem);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    emailList.innerHTML = `
                        <div class="text-center py-5 text-danger">
                            <i class="fas fa-exclamation-circle fa-3x mb-3"></i>
                            <p>Error loading emails. Please try again.</p>
                        </div>
                    `;
                });
        }
        
        // Function to search emails
        function searchEmails(query) {
            emailList.innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Searching emails...</p>
                </div>
            `;
            
            fetch(`/api/email/search?query=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(emails => {
                    if (emails.length === 0) {
                        emailList.innerHTML = `
                            <div class="text-center py-5 text-muted">
                                <i class="fas fa-search fa-3x mb-3"></i>
                                <p>No emails found matching "${query}"</p>
                            </div>
                        `;
                    } else {
                        emailList.innerHTML = '';
                        emails.forEach(email => {
                            const date = new Date(email.date);
                            const formattedDate = date.toLocaleDateString();
                            
                            const emailItem = document.createElement('a');
                            emailItem.href = '#';
                            emailItem.classList.add('list-group-item', 'list-group-item-action', 'email-item');
                            if (email.unread) {
                                emailItem.classList.add('unread');
                            }
                            emailItem.innerHTML = `
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">${email.from}</h6>
                                    <small>${formattedDate}</small>
                                </div>
                                <p class="mb-1 fw-bold">${email.subject}</p>
                                <p class="mb-0 email-preview">${email.snippet}</p>
                            `;
                            
                            emailItem.addEventListener('click', function(e) {
                                e.preventDefault();
                                viewEmail(email);
                            });
                            
                            emailList.appendChild(emailItem);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    emailList.innerHTML = `
                        <div class="text-center py-5 text-danger">
                            <i class="fas fa-exclamation-circle fa-3x mb-3"></i>
                            <p>Error searching emails. Please try again.</p>
                        </div>
                    `;
                });
        }
        
        // Function to view email
        function viewEmail(email) {
            currentEmail = email;
            
            // Update email detail header
            emailDetailHeader.textContent = email.subject;
            
            // Format date
            const date = new Date(email.date);
            const formattedDate = date.toLocaleString();
            
            // Update email detail
            emailDetail.innerHTML = `
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h5 class="mb-1">${email.from}</h5>
                            <div class="text-muted">To: ${email.to}</div>
                            ${email.cc ? `<div class="text-muted">CC: ${email.cc}</div>` : ''}
                        </div>
                        <div class="text-muted">${formattedDate}</div>
                    </div>
                    <hr>
                    <div class="email-body">
                        ${email.body.replace(/\n/g, '<br>')}
                    </div>
                </div>
            `;
            
            // Show email actions
            emailActions.style.display = 'block';
        }
        
        // Function to send email
        function sendEmail() {
            const to = document.getElementById('to').value;
            const cc = document.getElementById('cc').value;
            const bcc = document.getElementById('bcc').value;
            const subject = document.getElementById('subject').value;
            const body = document.getElementById('body').value;
            
            // Disable send button
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>Sending...';
            
            fetch('/api/email/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    to: to,
                    subject: subject,
                    body: body,
                    cc: cc || null,
                    bcc: bcc || null
                }),
            })
            .then(response => response.json())
            .then(data => {
                // Re-enable send button
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Send';
                
                // Close modal
                const composeModal = bootstrap.Modal.getInstance(document.getElementById('composeModal'));
                composeModal.hide();
                
                // Show success message
                alert('Email sent successfully!');
                
                // Reset form
                composeForm.reset();
            })
            .catch(error => {
                console.error('Error:', error);
                
                // Re-enable send button
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Send';
                
                // Show error message
                alert('Error sending email. Please try again.');
            });
        }
        
        // Function to prepare reply or forward
        function prepareReply(isForward) {
            if (!currentEmail) return;
            
            // Set reply title
            replyTitle.textContent = isForward ? 'Forward' : 'Reply';
            
            // Set reply form fields
            document.getElementById('reply-to').value = isForward ? '' : currentEmail.from;
            document.getElementById('reply-cc').value = '';
            
            const subject = currentEmail.subject;
            document.getElementById('reply-subject').value = isForward ? `Fwd: ${subject}` : `Re: ${subject}`;
            
            // Set reply body
            let replyBody = '';
            
            if (isForward) {
                replyBody = `\n\n---------- Forwarded message ---------\n`;
                replyBody += `From: ${currentEmail.from}\n`;
                replyBody += `Date: ${new Date(currentEmail.date).toLocaleString()}\n`;
                replyBody += `Subject: ${currentEmail.subject}\n`;
                replyBody += `To: ${currentEmail.to}\n\n`;
                replyBody += currentEmail.body;
            } else {
                replyBody = `\n\nOn ${new Date(currentEmail.date).toLocaleString()}, ${currentEmail.from} wrote:\n\n`;
                replyBody += currentEmail.body.split('\n').map(line => `> ${line}`).join('\n');
            }
            
            document.getElementById('reply-body').value = replyBody;
            
            // Show reply modal
            const replyModal = new bootstrap.Modal(document.getElementById('replyModal'));
            replyModal.show();
        }
        
        // Function to send reply
        function sendReply() {
            const to = document.getElementById('reply-to').value;
            const cc = document.getElementById('reply-cc').value;
            const subject = document.getElementById('reply-subject').value;
            const body = document.getElementById('reply-body').value;
            
            // Disable send button
            replySendBtn.disabled = true;
            replySendBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>Sending...';
            
            fetch('/api/email/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    to: to,
                    subject: subject,
                    body: body,
                    cc: cc || null,
                    bcc: null
                }),
            })
            .then(response => response.json())
            .then(data => {
                // Re-enable send button
                replySendBtn.disabled = false;
                replySendBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Send';
                
                // Close modal
                const replyModal = bootstrap.Modal.getInstance(document.getElementById('replyModal'));
                replyModal.hide();
                
                // Show success message
                alert('Email sent successfully!');
                
                // Reset form
                replyForm.reset();
            })
            .catch(error => {
                console.error('Error:', error);
                
                // Re-enable send button
                replySendBtn.disabled = false;
                replySendBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Send';
                
                // Show error message
                alert('Error sending email. Please try again.');
            });
        }
        
        // Function to delete email
        function deleteEmail() {
            if (!currentEmail) return;
            
            if (confirm('Are you sure you want to delete this email?')) {
                // TODO: Implement email deletion API
                alert('Email deletion not implemented yet.');
            }
        }
    });
</script>
{% endblock %}
